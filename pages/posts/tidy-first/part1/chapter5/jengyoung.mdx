# 읽는 순서

## 요약

코드를 읽을 때에는 독자의 입장이 되어, 먼저 읽도록 의도하고 싶은 코드의 순서를 배치하라는 내용이었어요.  
그리고 이는 자신의 경험을 살려 판단하며, 가장 읽기 좋은 코드 배치를 찾아나가야 해요.

## 예제

### 복잡한 인증 미들웨어 리팩토링하기.

아직도 생각나는 재밌는 코드가 하나 있는데요. 바로 대출 중개 서비스 관리자 기능 구축하는 건이었어요.  
중요한 작업임에도 불과하고, 개발팀에는 오직 1주일의 시간 안에, 상담사 관리자 기능을 구축하라는 요구사항이 들어왔어요. 😭

그리고 이는, 금융사 측과 이미 이야기를 나눈 건이었기에 번복이 어려웠고, 따라서 우리는 작업을 마쳐야 했어요.  
그 과정에서 저희는 시간 내에 구현하기 위해 다음과 같은 설계를 진행했어요.

- 아예 사이트를 새롭게 구축하는 것은 시간 내에 해결하기 힘든 문제이다.
- 미들웨어 서버에서 인증 로직을 거쳐, 권한 별로 접근 가능한 페이지를 구별하자.

저는 당시 SEO 작업 및 앱 구현을 진행 중이었기에, 팀원들에게 위 업무를 배정했는데요.  
사건은 배포 전날 발생했어요. 바로, 미들웨어에서의 인증 문제가 발생한 것이었죠.

응급 수술을 위해 디버깅을 하던 저는 코드를 개복하였지만, 코드의 복잡함에 대해 놀랐어요.  
코드를 공개할 수는 없지만, 다음과 같이 조건문이 적혀있었어요.

- 만약 인증이 필요하고 쿠키가 없을 경우
- 만약 쿠키가 없는 경우
- 만약 인증이 필요하지 않고 쿠키에 액세스 토큰이 있는 경우
  - 만약 권한이 없는 경우
- 만약 인증이 필요하고 쿠키에 액세스 토큰이 없는 경우
- 만약 인증이 필요하고 쿠키에 액세스 토큰이 있는 경우
  - 만약 만료된 액세스 토큰이거나 권한이 없는 경우

분기가 많다는 건 중요하지 않아요.  
중요한 건, 읽기 쉽도록 조건문이 그룹핑되지 않았다는 문제였어요.

따라서 저는 늦은 밤, 코드를 살리는 일에 돌입하기 시작했어요.  
그리고, 30분은 코드의 조건문 및 실행 로직만 한글로 변환하는 업무만 했죠.

이후 코드를 알고 나게 되니, 읽는 순서로 배치하는 것은 어렵지 않았고, 약 1시간 만에 인증 로직이 모두 마무리 됐어요.

- 쿠키가 유효하지 않은 경우

  - 인증이 필요한 경우
  - 인증이 필요하지 않은 경우

- 쿠키가 유효한 경우

  - 인증이 필요한 경우
  - 인증이 필요하지 않은 경우

이러한 배치는, 작업자가 원하는 것이 무엇일까를 고민한 결과였어요.

1. 쿠키는 액세스 토큰이 있는지가 중요한 게 아니라, 유효한지가 중요해요.

따라서 이에 대한 상태를 정의하는 변수를 만들고, 재사용했어요.

2. 리디렉션이 중첩될 수록 인증 조건에 대한 문제가 까다롭다 생각했어요.

복잡한 미들웨어에서는 인증이 필요한 케이스를 찾기는 어렵다 판단했어요. (페이지 별 인증이 각각 다른데, 얼만큼 리디렉션된 결과인지를 모르기 때문)  
그렇기 때문에 상대적으로 판단하기 쉬운, 유효한 쿠키인지를 확인하는 것을 먼저 분기로 구분 짓고, 복잡한 문제를 들여다 볼 수 있도록 작성했어요.

결과적으로 해당 미들웨어 코드를 리팩토링함으로써, 미들웨어 함수에서 약 50%의 코드를 줄여 가독성을 높였어요.  
이후 분리된 로직은 메서드로 재사용하며, 복잡한 문제를 선언적으로 해결할 수 있게 되었어요 👋🏻
